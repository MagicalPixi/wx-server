var api = require('./api')
var oauth = require('./oauth')
var model = require('../models')
var domin = 'http://wx.easyell.com'

var authorize = function(res) {
  var url = oauth.getAuthorizeURL(domin + '/game', '123', 'snsapi_userinfo');
  res.redirect(url)
}

var checkAuthorize = function(req, res, next) {
  var code = req.query.code
  if (code) {
    oauth.getUserByCode(code, function (err, result) {
      if(err) {
        authorize(res)
      } else  {
        res.userInfo = result
        var User = model.User
        User.findOne({openid: openid}, function(a, user) {
          user = user || new User({openid: openid})
          user.info = result
          user.save(function(e, v) {
            next()
          })
        })
      }
    })
  } else  {
    authorize(res)
  }
}

var getGameView = function(req, res, next) {
  var param = {
    debug: true,
    jsApiList: ['translateVoice', 'startRecord', 'stopRecord', 'playVoice', 'pauseVoice', 'stopVoice', 'onVoicePlayEnd', 'uploadVoice', 'downloadVoice'],
    url: domin + req.originalUrl
  }
  api.getJsConfig(param, function(err, result) {
    if (err) console.log(err)
    res.render('index', {config: result})
  })
}

var configExample = function(req, res, next) {
  var param = {
    debug: true,
    jsApiList: ['translateVoice', 'startRecord', 'stopRecord', 'playVoice', 'pauseVoice', 'stopVoice', 'onVoicePlayEnd', 'uploadVoice', 'downloadVoice'],
    url: 'http://wx.easyell.com/config'
  }
  api.getJsConfig(param, function(err, result) {
    if (err) console.log(err)
    res.render('index', {config: result})
  })
}

module.exports = {
  getGameView: getGameView,
  checkAuthorize: checkAuthorize,
  configExample: configExample
}